name: Issue Notification
on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send Google Chat Notification
        run: |
          # 1. Issueã®æœ¬æ–‡ã‹ã‚‰Thread IDï¼ˆspaces/X/threads/Yï¼‰ã‚’æŠ½å‡º
          # grepã§IDã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã«ä¸€è‡´ã™ã‚‹éƒ¨åˆ†ã‚’æŠœãå‡ºã—ã¾ã™
          THREAD_ID=$(echo "${{ github.event.issue.body }}" | grep -o 'spaces/[^ ]*/threads/[^ ]*' | head -1)

          # 2. é€šçŸ¥å†…å®¹ã®æº–å‚™ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆã‹Issueæœ¬æ–‡ã‹ï¼‰
          CONTENT="${{ github.event.comment.body || github.event.issue.body }}"
          
          # JSONã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å‡¦ç†
          SAFE_CONTENT=$(echo "$CONTENT" | python3 -c 'import json,sys; print(json.dumps(sys.stdin.read()))')

          # 3. Google Chatã¸POSTé€ä¿¡
          # URLã« messageReplyOption=REPLY_MESSAGE_FALLBACK ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã§ã€ã‚¹ãƒ¬ãƒƒãƒ‰ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã‚‚æ–°è¦æŠ•ç¨¿ã¨ã—ã¦å‡¦ç†ã•ã‚Œã¾ã™
          curl -X POST "${{ secrets.GOOGLE_CHAT_WEBHOOK }}&messageReplyOption=REPLY_MESSAGE_FALLBACK" \
          -H "Content-Type: application/json; charset=UTF-8" \
          -d "{
            \"text\": \"ğŸ“‹ *Issueæ›´æ–°: ${{ github.event.issue.title }}*\n\nğŸ‘¤ *å®Ÿè¡Œè€…*: ${{ github.actor }} (${{ github.event.action }})\n\nğŸ“ *å†…å®¹*:\n${SAFE_CONTENT:1:-1}\n\nğŸ”— *URL*: ${{ github.event.comment.html_url || github.event.issue.html_url }}\",
            \"thread\": { \"threadKey\": \"$THREAD_ID\" }
          }"
