name: Google Chat Japanese Card Notification

on:
  issues:
    types: [opened, edited, reopened, closed]
  issue_comment:
    types: [created]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send Japanese Card Notification
        env:
          WEBHOOK_URL: ${{ secrets.GOOGLE_CHAT_WEBHOOK }}
        run: |
          # 1. データの取得
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          ISSUE_TITLE="${{ github.event.issue.title }}"
          ACTOR="${{ github.actor }}"
          
          # 【ロジック追加】本文(body)から「投稿者:」の後の名前を抽出
          # 1. 本文から "投稿者:" を含む行を探す
          # 2. "投稿者:" 以降の文字列を取り出す
          # 3. 前後の空白や不要な記号(※)を削除
          RAW_BODY="${{ github.event.issue.body }}"
          EXTRACTED_SENDER=$(echo "$RAW_BODY" | grep "投稿者:" | head -n 1 | sed 's/.*投稿者[:：]//' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | sed 's/\*\*//g')

          # もし本文から抽出できなかった場合は、GitHubのユーザー名(login)をフォールバックとして使用
          if [ -z "$EXTRACTED_SENDER" ]; then
            SENDER="${{ github.event.sender.login }}"
          else
            SENDER="$EXTRACTED_SENDER"
          fi
          
          case "${{ github.event.action }}" in
            "opened")   ACTION_JP="新規課題が登録されました" ;;
            "edited")   ACTION_JP="課題が更新されました" ;;
            "reopened") ACTION_JP="課題が再オープンされました" ;;
            "closed")   ACTION_JP="課題が解決（クローズ）されました" ;;
            "created")  ACTION_JP="コメントが追加されました" ;;
            *)          ACTION_JP="${{ github.event.action }}" ;;
          esac

          if [ "${{ github.event_name }}" = "issue_comment" ]; then
            HEADER_TITLE="Issue #${ISSUE_NUMBER}: $ACTION_JP"
            CONTENT="${{ github.event.comment.body }}"
            URL="${{ github.event.comment.html_url }}"
            ICON="https://fonts.gstatic.com/s/i/short-term/release/googlestandardsymbols/chat_bubble/default/48px.svg"
          else
            HEADER_TITLE="Issue #${ISSUE_NUMBER}: $ACTION_JP"
            CONTENT="${{ github.event.issue.body }}"
            URL="${{ github.event.issue.html_url }}"
            ICON="https://fonts.gstatic.com/s/i/short-term/release/googlestandardsymbols/assignment/default/48px.svg"
          fi

          # 2. 本文の整形（jqでエスケープ）
          SUMMARY=$(echo "$CONTENT" | head -n 5 | jq -aRs . | sed 's/^"//;s/"$//')

          # 3. JSONデータの構築
          # subtitleに抽出した $SENDER を表示
          JSON_DATA=$(cat <<EOF
          {
            "cardsV2": [{
              "cardId": "issue-card",
              "card": {
                "header": {
                  "title": "$HEADER_TITLE",
                  "subtitle": "投稿者: $SENDER / 実行者: $ACTOR",
                  "imageUrl": "$ICON",
                  "imageType": "CIRCLE"
                },
                "sections": [{
                  "widgets": [
                    { "textParagraph": { "text": "<b>タイトル:</b><br>$ISSUE_TITLE" } },
                    { "textParagraph": { "text": "<b>内容:</b><br>$SUMMARY" } },
                    {
                      "buttonList": {
                        "buttons": [{
                          "text": "GitHubで詳細を見る",
                          "onClick": { "openLink": { "url": "$URL" } }
                        }]
                      }
                    }
                  ]
                }]
              }
            }],
            "thread": { "threadKey": "issue-$ISSUE_NUMBER" }
          }
          EOF
          )

          # 4. 送信
          curl -s -X POST -H 'Content-Type: application/json' \
          -d "$JSON_DATA" \
          "${WEBHOOK_URL}&messageReplyOption=REPLY_MESSAGE_FALLBACK_TO_NEW_THREAD"
