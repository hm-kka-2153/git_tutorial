name: Google Chat Threaded Notification

on:
  issues:
    # opened: æ–°è¦ä½œæˆ, edited: ã‚¿ã‚¤ãƒˆãƒ«ã‚„æœ¬æ–‡ã®ç·¨é›†
    types: [opened, edited, reopened]
  issue_comment:
    # ã‚³ãƒ¡ãƒ³ãƒˆãŒä½œæˆã•ã‚ŒãŸæ™‚
    types: [created]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send Notification
        env:
          # å¿…ãš Settings > Secrets > Actions ã« GOOGLE_CHAT_WEBHOOK ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„
          WEBHOOK_URL: ${{ secrets.GOOGLE_CHAT_WEBHOOK }}
        run: |
          # 1. threadKeyã®æ±ºå®š (Issueç•ªå·ã‚’ãƒ™ãƒ¼ã‚¹ã«ã™ã‚‹)
          # issue_commentã‚¤ãƒ™ãƒ³ãƒˆã®å ´åˆã¯ github.event.issue.number ã‚’å‚ç…§
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          THREAD_KEY="issue-${ISSUE_NUMBER}"

          # 2. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æœ¬æ–‡ã®ä½œæˆ
          # Issueä½œæˆ/ç·¨é›†ã‹ã€ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ã‹ã§æ–‡è¨€ã‚’å¤‰ãˆã‚‹ä¾‹
          if [ "${{ github.event_name }}" = "issue_comment" ]; then
            TEXT="ğŸ’¬ *Issueã«ã‚³ãƒ¡ãƒ³ãƒˆãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸ*\n**Issue:** #${ISSUE_NUMBER} ${{ github.event.issue.title }}\n**ã‚³ãƒ¡ãƒ³ãƒˆ:** ${{ github.event.comment.body }}\n**URL:** ${{ github.event.comment.html_url }}"
          else
            TEXT="ğŸ“‹ *IssueãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ (${{ github.event.action }})*\n**ã‚¿ã‚¤ãƒˆãƒ«:** ${{ github.event.issue.title }}\n**URL:** ${{ github.event.issue.html_url }}"
          fi

          # 3. é€ä¿¡ (URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å¼•ç”¨ç¬¦ã§å›²ã‚€ã®ãŒã‚³ãƒ„)
          curl -X POST -H 'Content-Type: application/json' \
          -d "{
            \"text\": \"$TEXT\",
            \"thread\": { \"threadKey\": \"$THREAD_KEY\" }
          }" \
          "${WEBHOOK_URL}&messageReplyOption=REPLY_MESSAGE_FALLBACK_TO_NEW_THREAD"
