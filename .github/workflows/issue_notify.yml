name: Google Chat Notify

on:
  issues:
    types: [opened, edited]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      # 1. Google Cloud èªè¨¼ (secrets.GOOGLE_CHAT_CREDENTIALS ã‚’ä½¿ç”¨)
      - name: Auth Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GOOGLE_CHAT_CREDENTIALS }}

      # 2. Issueæƒ…å ±ã‚’å–å¾—ã—ã€Thread IDã‚’è§£æã—ã¦Chatã¸é€ä¿¡
      - name: Send Message to Thread
        env:
          # ç‰¹æ®Šæ–‡å­—ã«ã‚ˆã‚‹ã‚·ã‚§ãƒ«ã‚¨ãƒ©ãƒ¼ã‚’é˜²ããŸã‚ã€envçµŒç”±ã§å¤‰æ•°åŒ–ã—ã¾ã™
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_URL: ${{ github.event.issue.html_url }}
          ACTION: ${{ github.event.action }}
        run: |
          # æœ¬æ–‡ã‹ã‚‰ Thread ID (spaces/.../threads/...) ã‚’æŠ½å‡º
          # grep -o ã§ãƒãƒƒãƒã—ãŸéƒ¨åˆ†ã®ã¿ã‚’æŠœãå‡ºã—ã¾ã™
          THREAD_ID=$(echo "$ISSUE_BODY" | grep -o 'spaces/[A-Za-z0-9_-]*/threads/[A-Za-z0-9_-]*' | head -n 1)

          if [ -z "$THREAD_ID" ]; then
            echo "âš ï¸ Thread ID not found in issue body. Notification skipped."
            exit 0
          fi

          echo "âœ… Target Thread Found: $THREAD_ID"

          # Thread IDã‹ã‚‰Space IDã®éƒ¨åˆ†ã ã‘ã‚’æŠ½å‡º (spaces/XXXXXX)
          SPACE_ID=$(echo "$THREAD_ID" | cut -d'/' -f1,2)

          # Google Chat API å®Ÿè¡Œ
          # messageReplyOption ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§ã€æ—¢å­˜ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã¸ç¢ºå®Ÿã«è¿”ä¿¡ã—ã¾ã™
          curl -X POST \
            -H "Authorization: Bearer $(gcloud auth print-access-token)" \
            -H "Content-Type: application/json" \
            "https://chat.googleapis.com/v1/$SPACE_ID/messages?messageReplyOption=REPLY_MESSAGE_FALLBACK_TO_NEW_THREAD" \
            -d "{
              \"text\": \"ğŸ”„ **GitHub Issue $ACTION**\nã‚¿ã‚¤ãƒˆãƒ«: $ISSUE_TITLE\nURL: $ISSUE_URL\",
              \"thread\": { \"name\": \"$THREAD_ID\" }
            }"
