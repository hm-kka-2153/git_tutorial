name: Google Chat Threaded Notification

on:
  issues:
    types: [opened, edited, reopened]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send Notification with threadKey
        env:
          # Webhook URLã¯GitHubã®Secretsã«ç™»éŒ²ã—ã¦ä½¿ç”¨ã—ã¦ãã ã•ã„
          WEBHOOK_URL: ${{ secrets.GOOGLE_CHAT_WEBHOOK }}
        run: |
          # 1. URLã«ã‚¹ãƒ¬ãƒƒãƒ‰è¿”ä¿¡ç”¨ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä»˜ä¸
          # 2. threadKeyã¨ã—ã¦Issueç•ªå·ã‚’æŒ‡å®šï¼ˆã“ã‚Œã§Issueã”ã¨ã«ã‚¹ãƒ¬ãƒƒãƒ‰ãŒå›ºå®šã•ã‚Œã¾ã™ï¼‰
          # 3. messageReplyOptionã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§ã€åˆå›ã¯æ–°è¦ã€2å›ç›®ä»¥é™ã¯è¿”ä¿¡ã«ãªã‚Šã¾ã™
          
          FINAL_URL="${WEBHOOK_URL}&messageReplyOption=REPLY_MESSAGE_FALLBACK_TO_NEW_THREAD"
          
          JSON_DATA=$(cat <<EOF
          {
            "text": "ğŸ“‹ *Issueé€šçŸ¥*\n**ã‚¿ã‚¤ãƒˆãƒ«:** ${{ github.event.issue.title }}\n**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:** ${{ github.event.action }}\n**URL:** ${{ github.event.issue.html_url }}",
            "thread": {
              "threadKey": "issue-${{ github.event.issue.number }}"
            }
          }
          EOF
          )

          curl -X POST -H 'Content-Type: application/json' \
          -d "$JSON_DATA" \
          "$FINAL_URL"
