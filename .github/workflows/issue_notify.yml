name: Google Chat Notify
on:
  issues:
    types: [opened, edited] # ä½œæˆã¨æ›´æ–°ã®ä¸¡æ–¹

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      # 1. Google Cloud èªè¨¼ï¼ˆæˆåŠŸç¢ºèªæ¸ˆã¿ï¼‰
      - name: Auth Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GOOGLE_CHAT_CREDENTIALS }}

      # 2. Issueã®å†…å®¹ã‚’è§£æã—ã¦è¿”ä¿¡
      - name: Send Message to Thread
        run: |
          # 1. å¿…è¦ãªæƒ…å ±ã®å–å¾—
          ISSUE_BODY="${{ github.event.issue.body }}"
          ISSUE_TITLE="${{ github.event.issue.title }}"
          ISSUE_URL="${{ github.event.issue.html_url }}"
          ACTION="${{ github.event.action }}"

          # 2. æœ¬æ–‡ã‹ã‚‰ Thread ID ã‚’æŠ½å‡º
          THREAD_ID=$(echo "$ISSUE_BODY" | grep -oP 'Thread ID:\s*\K(spaces/[A-Za-z0-9_-]+/threads/[A-Za-z0-9_-]+)')

          if [ -z "$THREAD_ID" ]; then
            echo "âŒ æœ¬æ–‡ã« Thread ID ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚é€šçŸ¥ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
            exit 0
          fi

          # 3. ã‚¹ãƒšãƒ¼ã‚¹IDã‚’åˆ‡ã‚Šå‡ºã— (spaces/XXXXX)
          SPACE_ID=$(echo "$THREAD_ID" | cut -d'/' -f1,2)

          # 4. Google Chat API ã¸ POST
          curl -X POST \
            -H "Authorization: Bearer $(gcloud auth print-access-token)" \
            -H "Content-Type: application/json" \
            "https://chat.googleapis.com/v1/$SPACE_ID/messages?messageReplyOption=REPLY_MESSAGE_FALLBACK_TO_NEW_THREAD" \
            -d "{
              \"text\": \"ğŸ”„ **GitHub Issue $ACTION**\nã‚¿ã‚¤ãƒˆãƒ«: $ISSUE_TITLE\nURL: $ISSUE_URL\",
              \"thread\": { \"name\": \"$THREAD_ID\" }
            }"
