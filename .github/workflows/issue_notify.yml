name: Google Chat Debug

on:
  issues:
    types: [opened, edited]

jobs:
  debug-notify:
    runs-on: ubuntu-latest
    steps:
      - name: Auth Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GOOGLE_CHAT_CREDENTIALS }}

      - name: Debug and Send
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_URL: ${{ github.event.issue.html_url }}
        run: |
          echo "--- 1. å¤‰æ•°ã®æŠ½å‡ºãƒ†ã‚¹ãƒˆ ---"
          # Thread IDã‚’æŠ½å‡ºã—ã¦è¡¨ç¤º
          THREAD_ID=$(echo "$ISSUE_BODY" | grep -o 'spaces/[A-Za-z0-9_-]*/threads/[A-Za-z0-9_-]*' | head -n 1)
          echo "æŠ½å‡ºã•ã‚ŒãŸ Thread ID: [$THREAD_ID]"

          if [ -z "$THREAD_ID" ]; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: æœ¬æ–‡ã‹ã‚‰ Thread ID ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚"
            echo "æœ¬æ–‡ã®å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„: $ISSUE_BODY"
            exit 1
          fi

          SPACE_ID=$(echo "$THREAD_ID" | cut -d'/' -f1,2)
          echo "åˆ‡ã‚Šå‡ºã•ã‚ŒãŸ Space ID: [$SPACE_ID]"

          echo "--- 2. APIé€ä¿¡ãƒ†ã‚¹ãƒˆ (è©³ç´°ãƒ­ã‚°å‡ºåŠ›) ---"
          # curl ã« -i ã‚’ã¤ã‘ã¦ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ±ã‚’è¡¨ç¤ºã—ã€APIã®ç”Ÿã®å¿œç­”ã‚’ç¢ºèªã—ã¾ã™
          # èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
          TOKEN=$(gcloud auth print-access-token)

          RESPONSE=$(curl -s -i -X POST \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            "https://chat.googleapis.com/v1/$SPACE_ID/messages?messageReplyOption=REPLY_MESSAGE_FALLBACK_TO_NEW_THREAD" \
            -d "{
              \"text\": \"ğŸ›  ãƒ‡ãƒãƒƒã‚°é€šçŸ¥\nã‚¿ã‚¤ãƒˆãƒ«: $ISSUE_TITLE\",
              \"thread\": { \"name\": \"$THREAD_ID\" }
            }")

          echo "--- 3. APIãƒ¬ã‚¹ãƒãƒ³ã‚¹çµæœ ---"
          echo "$RESPONSE"
