name: Google Chat Rich Notification

on:
  issues:
    types: [opened, edited, reopened]
  issue_comment:
    types: [created]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send Rich Card Notification
        env:
          WEBHOOK_URL: ${{ secrets.GOOGLE_CHAT_WEBHOOK }}
        run: |
          # 1. 共通変数の設定
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          ISSUE_TITLE="${{ github.event.issue.title }}"
          SENDER="${{ github.actor }}"
          
          # イベントの種類によってアイコンとタイトルを切り替え
          if [ "${{ github.event_name }}" = "issue_comment" ]; then
            CARD_TITLE="Comment Added to #$ISSUE_NUMBER"
            SUBTITLE="New comment from $SENDER"
            IMAGE_URL="https://fonts.gstatic.com/s/i/short-term/release/googlestandardsymbols/chat_bubble/default/48px.svg"
            CONTENT="${{ github.event.comment.body }}"
            URL="${{ github.event.comment.html_url }}"
          else
            CARD_TITLE="Issue ${{ github.event.action }}: #$ISSUE_NUMBER"
            SUBTITLE="Modified by $SENDER"
            IMAGE_URL="https://fonts.gstatic.com/s/i/short-term/release/googlestandardsymbols/assignment/default/48px.svg"
            CONTENT="${{ github.event.issue.body }}"
            URL="${{ github.event.issue.html_url }}"
          fi

          # 2. カード形式のJSON構築 (2000文字制限対策でbodyを切り詰め)
          BODY_TEXT=$(echo "$CONTENT" | head -n 5 | sed 's/"/\\"/g')
          
          JSON_DATA=$(cat <<EOF
          {
            "cardsV2": [{
              "cardId": "issue-card",
              "card": {
                "header": {
                  "title": "$CARD_TITLE",
                  "subtitle": "$SUBTITLE",
                  "imageUrl": "$IMAGE_URL",
                  "imageType": "CIRCLE"
                },
                "sections": [{
                  "header": "Detail",
                  "widgets": [
                    { "textParagraph": { "text": "<b>Title:</b> $ISSUE_TITLE" } },
                    { "textParagraph": { "text": "<b>Summary:</b><br>$BODY_TEXT" } },
                    {
                      "buttonList": {
                        "buttons": [{
                          "text": "View on GitHub",
                          "onClick": { "openLink": { "url": "$URL" } }
                        }]
                      }
                    }
                  ]
                }]
              }
            }],
            "thread": { "threadKey": "issue-$ISSUE_NUMBER" }
          }
          EOF
          )

          # 3. 送信
          curl -X POST -H 'Content-Type: application/json' \
          -d "$JSON_DATA" \
          "${WEBHOOK_URL}&messageReplyOption=REPLY_MESSAGE_FALLBACK_TO_NEW_THREAD"
