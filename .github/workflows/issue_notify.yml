name: Notify Google Chat on Issue Update

on:
  issues:
    types: [opened, edited, reopened] # é€šçŸ¥ã—ãŸã„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’é¸æŠ

jobs:
  notify-chat:
    runs-on: ubuntu-latest
    steps:
      - name: Send Notification to Google Chat
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GOOGLE_CHAT_CREDENTIALS }}

      - name: Post to Google Chat
        run: |
          # Issueã®æœ¬æ–‡ã‹ã‚‰ã‚¹ãƒ¬ãƒƒãƒ‰IDã‚’æŠ½å‡ºï¼ˆå‰ã®ãƒ­ã‚¸ãƒƒã‚¯ã¨åŒæ§˜ï¼‰
          ISSUE_BODY="${{ github.event.issue.body }}"
          THREAD_ID=$(echo "$ISSUE_BODY" | grep -oP 'Thread ID:\s*\K(spaces/[A-Za-z0-9_-]+/threads/[A-Za-z0-9_-]+)')

          if [ -z "$THREAD_ID" ]; then
            echo "Thread ID not found in issue body. Skipping notification."
            exit 0
          fi

          SPACE_ID=$(echo "$THREAD_ID" | cut -d'/' -f1,2)

          # Google Chat APIã‚’ç›´æ¥å©ã
          curl -X POST \
            -H "Authorization: Bearer $(gcloud auth print-access-token)" \
            -H "Content-Type: application/json" \
            "https://chat.googleapis.com/v1/$SPACE_ID/messages?messageReplyOption=REPLY_MESSAGE_FALLBACK_TO_NEW_THREAD" \
            -d "{
              \"text\": \"ğŸ”” **GitHub Issueæ›´æ–°é€šçŸ¥**\nã‚¿ã‚¤ãƒˆãƒ«: ${{ github.event.issue.title }}\nURL: ${{ github.event.issue.html_url }}\",
              \"thread\": { \"name\": \"$THREAD_ID\" }
            }"
